version: "3.8"

services:
  postgres:
    image: postgres:15-alpine
    container_name: user-aggregator-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  mysql:
    image: mysql:8.0
    container_name: user-aggregator-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: mysql_db
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-prootpassword",
        ]
      interval: 5s
      timeout: 5s
      retries: 5
    command: --default-authentication-plugin=mysql_native_password

  oracle:
    image: gvenzl/oracle-xe:21-slim
    container_name: user-aggregator-oracle
    environment:
      ORACLE_PASSWORD: oracle
    ports:
      - "1521:1521"
    volumes:
      - oracle_data:/opt/oracle/oradata
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "sqlplus -s system/oracle@localhost:1521/XE <<< 'SELECT 1 FROM DUAL;' || exit 1",
        ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s

  mariadb:
    image: mariadb:10.11
    container_name: user-aggregator-mariadb
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: mariadb_db
    ports:
      - "3307:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-prootpassword",
        ]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-init:
    image: postgres:15-alpine
    container_name: user-aggregator-postgres-init
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./liquibase/postgres:/scripts:ro
    environment:
      PGPASSWORD: postgres
    command: >
      sh -c "
        echo 'Initializing Postgres...' &&
        psql -h postgres -U postgres -d postgres -f /scripts/init.sql &&
        echo 'Postgres initialized successfully!'
      "
    networks:
      - default

  mysql-init:
    image: mysql:8.0
    container_name: user-aggregator-mysql-init
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - ./liquibase/mysql:/scripts:ro
    command: >
      sh -c "
        echo 'Waiting for MySQL...' &&
        sleep 3 &&
        echo 'Initializing MySQL...' &&
        mysql -h mysql -u root -prootpassword mysql_db < /scripts/init.sql &&
        echo 'MySQL initialized successfully!'
      "
    networks:
      - default

  mariadb-init:
    image: mariadb:10.11
    container_name: user-aggregator-mariadb-init
    depends_on:
      mariadb:
        condition: service_healthy
    volumes:
      - ./liquibase/mariadb:/scripts:ro
    command: >
      sh -c "
        echo 'Waiting for MariaDB...' &&
        sleep 3 &&
        echo 'Initializing MariaDB...' &&
        mysql -h mariadb -u root -prootpassword mariadb_db < /scripts/init.sql &&
        echo 'MariaDB initialized successfully!'
      "
    networks:
      - default

  oracle-init:
    image: gvenzl/oracle-xe:21-slim
    container_name: user-aggregator-oracle-init
    depends_on:
      oracle:
        condition: service_healthy
    volumes:
      - ./liquibase/oracle:/scripts:ro
    environment:
      ORACLE_PASSWORD: oracle
    command: >
      bash -c "
        echo 'Waiting for Oracle...' &&
        sleep 5 &&
        echo 'Initializing Oracle...' &&
        sqlplus -S system/oracle@oracle:1521/XE @/scripts/init.sql <<EOF
        EXIT
        EOF
        echo 'Oracle initialized successfully!'
      "
    networks:
      - default

volumes:
  postgres_data:
  mysql_data:
  oracle_data:
  mariadb_data:
